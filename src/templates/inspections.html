{% extends "base.html" %}

{% block title %}Inspections{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Inspection Records</h2>
    <a href="{{ url_for("main.add_inspection") }}" class="btn btn-primary">Add New Record</a>
</div>

{% if grouped_inspections %}
    {% for substation_name, year_months in grouped_inspections.items() %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">{{ substation_name }}</h4>
        </div>
        <div class="card-body">
            {% for year_month, inspections in year_months.items() %}
            <div class="mb-4">
                <h5 class="text-secondary border-bottom pb-2">
                    <i class="fas fa-calendar-alt me-2"></i>
                    {{ year_month | replace("-", " - ") }}
                    <span class="badge bg-info ms-2">{{ inspections|length }} record(s)</span>
                </h5>
                
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>Inspection Date</th>
                                <th>Testing Date</th>
                                <th>Inspection Status</th>
                                <th>Testing Status</th>
                                <th>Notes</th>
                                <th>Recorded By</th>
                                <th>Date Added</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for inspection in inspections %}
                            <tr>
                                <td>
                                    <span class="badge bg-success">
                                        {{ inspection.inspection_date.strftime("%Y-%m-%d") }}
                                    </span>
                                </td>
                                <td>
                                    {% if inspection.testing_date %}
                                        <span class="badge bg-warning text-dark">
                                            {{ inspection.testing_date.strftime("%Y-%m-%d") }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if inspection.inspection_status == "Inspected" %}
                                        <span class="badge bg-success">{{ inspection.inspection_status }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ inspection.inspection_status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if inspection.testing_status == "Tested" %}
                                        <span class="badge bg-success">{{ inspection.testing_status }}</span>
                                    {% elif inspection.testing_status == "Not Tested" %}
                                        <span class="badge bg-danger">{{ inspection.testing_status }}</span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if inspection.notes %}
                                        <span class="text-truncate d-inline-block" style="max-width: 200px;" title="{{ inspection.notes }}">
                                            {{ inspection.notes }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">No notes</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if inspection.user %}
                                        <span class="badge bg-secondary">{{ inspection.user.username }}</span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ inspection.created_at.strftime("%Y-%m-%d %H:%M") }}
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="alert alert-info" role="alert">
        <h4 class="alert-heading">No Inspection Records Found</h4>
        <p>There are currently no inspection records in the system.</p>
        <hr>
        <p class="mb-0">
            <a href="{{ url_for("main.add_inspection") }}" class="btn btn-primary">Add First Inspection Record</a>
        </p>
    </div>
{% endif %}

<!-- Summary Statistics -->
{% if grouped_inspections %}
<div class="row mt-5">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Summary Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-primary">{{ grouped_inspections.keys()|length }}</h4>
                            <p class="text-muted">Substations with Records</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-success">
                                {% set total_records = 0 %}
                                {% for substation_name, year_months in grouped_inspections.items() %}
                                    {% for year_month, inspections in year_months.items() %}
                                        {% set total_records = total_records + inspections|length %}
                                    {% endfor %}
                                {% endfor %}
                                {{ total_records }}
                            </h4>
                            <p class="text-muted">Total Records</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-info">
                                {% set unique_months = [] %}
                                {% for substation_name, year_months in grouped_inspections.items() %}
                                    {% for year_month in year_months.keys() %}
                                        {% if year_month not in unique_months %}
                                            {% set _ = unique_months.append(year_month) %}
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                                {{ unique_months|length }}
                            </h4>
                            <p class="text-muted">Unique Months</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-warning">
                                {% set current_month = moment().format("YYYY-MM") %}
                                {% set current_month_records = 0 %}
                                {% for substation_name, year_months in grouped_inspections.items() %}
                                    {% if current_month in year_months %}
                                        {% set current_month_records = current_month_records + year_months[current_month]|length %}
                                    {% endif %}
                                {% endfor %}
                                {{ current_month_records }}
                            </h4>
                            <p class="text-muted">This Month's Records</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Add some interactivity for better user experience
    document.addEventListener('DOMContentLoaded', function() {
        // Add tooltips to truncated notes
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Add smooth scrolling for better navigation
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });
    });
</script>
{% endblock %}
